
jQuery.fn.hsPick=function(url,tip,box,fil){if(fil==undefined&&typeof url=="function"){fil=url;url=tip;tip=null}else{if(url==undefined){url=tip;tip=null}}var form=box.closest(".HsForm").data("HsForm")||{};var n=box.attr("name")||box.attr("data-fn");var v={};var vk=box.attr("data-vk")||"id";var tk=box.attr("data-tk")||"name";var mul=/(\[\]|\.\.|\.$)/.test(n);var btn=jQuery(this);if(!fil){do{fil=form["_fill_"+n];if(fil){break}var t;t=box.attr("data-ft");fil=form["_fill_"+t];if(fil){break}t=box.attr("data-fn");fil=form["_fill_"+t];if(fil){break}fil=hsFormFillPick}while(false)}if(box.is("input")){var val=box.val();var txt=btn.text();if(val){v[val]=txt}}else{box.find("li").each(function(){var opt=jQuery(this);var val=opt.find(".pickval").val();var txt=opt.find(".picktxt").text();v[val]=txt})}function pickItem(val,txt){var evt=jQuery.Event("pickItem");box.trigger(evt,arguments);if(evt.isDefaultPrevented()){return false}if(!mul){for(var key in v){delete v[key]}if(txt!==undefined){v[val]=txt}}else{if(txt!==undefined){v[val]=txt}else{delete v[val]}}return true}function pickBack(){if(jQuery.isEmptyObject(v)){var msg=box.data("unpickedError");if(msg!="!"){alert(msg?hsGetLang(msg):hsGetLang("fork.unpicked"));return}}var evt=jQuery.Event("pickBack");box.trigger(evt,[v,tip]);if(evt.isDefaultPrevented()){return false}fil.call(form,box,v,n,"data");box.trigger("change");return true}function pickOpen(){var tip=jQuery(this);tip.data("pickData",v).addClass("pickbox").toggleClass("pickmul",mul).on("change",".checkone",checks).on("click",".ensure",ensure).on("saveBack",".create",create);tip.find(".checkone").val(Object.keys(v))}function checks(){var chk=jQuery(this);if(chk.closest(".HsList").data("HsList")._info){return}if(chk.closest(".openbox").is(tip)==false){return}var val=chk.val();var txt;var inf;do{if(!chk.prop("checked")){break}inf=chk.data();if(!inf){inf=chk.attr("data-data");if(inf){inf=eval("("+inf+")")}else{inf=null}}txt=chk.attr("data-name");if(txt){break}txt=chk.closest("tr").find(".name").text();if(txt){break}var thd=chk.closest("table").find("thead");var tds=chk.closest("tr").find("td");var idx;idx=thd.find("[data-fn='"+tk+"']").index();if(idx!=-1){txt=tds.eq(idx).text()}if(txt){break}idx=thd.find("[data-ft='"+tk+"']").index();if(idx!=-1){txt=tds.eq(idx).text()}if(txt){break}idx=thd.find("[data-ft=name]").index();if(idx!=-1){txt=tds.eq(idx).text()}}while(false);if(pickItem(val,txt,inf)===false){chk.prop("checked",false);return false}}function ensure(){var btn=jQuery(this);if(!btn.closest(".openbox").is(tip)){return}if(!pickBack()){return false}tip.hsClose();return false}function create(evt,rst){var btn=jQuery(this);if(!btn.closest(".openbox").is(tip)){return}if(!rst||!rst.info){return false}if(!pickItem(rst.info[vk],rst.info[tk])){return false}if(!pickBack()){return false}tip.hsClose();return false}if(tip){tip=tip.hsOpen(url,undefined,pickOpen);tip.data("rel",btn.closest(".openbox")[0])}else{tip=jQuery.hsOpen(url,undefined,pickOpen)}return tip};function hsFormFillPick(k,o,c,q){k.data("pickFunc",hsFormFillPick);var a=k.siblings("[data-toggle=hsPick],[data-toggle=hsFork]");var d=/(\[\]|\.\.|\.$)/.test(c);if(q=="info"){var p=k.attr("data-ak")||c.replace(/_id$/,"");o=hsGetValue(this._info,p);if(!o){return}if(!d){o=[o]}}if(jQuery.isArray(o)){var e=k.attr("data-vk")||"id";var s=k.attr("data-tk")||"name";var m={};for(var h=0;h<o.length;h++){var f=o[h];m[f[e]]=f[s]}o=m}else{if(!jQuery.isPlainObject(o)){o={}}}if(k.is("input")){function l(t,n){var i=n.data("txt");var j=n.data("cls");t.val("");n.text(i);n.attr("class",j)}function r(n,j,t,i){n.val(t);j.text(i);j.addClass("btn-success");j.append('<a href="javascript:;" class="close">&times;</a>')}if(!a.data("pickInited")){a.data("pickInited",1);a.data("txt",a.text());a.data("cls",a.attr("class"));a.on("click",".close",k,function(i){var j=jQuery(i.delegateTarget);var n=i.data;l(n,j);n.trigger("change");return false})}if(jQuery.isEmptyObject(o)){l(k,a)}else{for(var b in o){var g=o[b];r(k,a,b,g)}}}else{if(!k.data("pickInited")){k.data("pickInited",1);k.on("click",".close",a,function(i){var n=jQuery(this).closest("li");var t=n.find(":hidden").val();var j=i.data;delete o[t];n.remove();j.show();k.trigger("change");return false});if(!d){k.on("click",null,a,function(i){i.data.click()})}}if(jQuery.isEmptyObject(o)){a.show()}else{if(!d){a.hide()}}k.empty();for(var b in o){var g=o[b];k.append(jQuery('<li class="btn btn-success form-control"></li>').attr("title",g).append(jQuery('<input class="pickval" type="hidden"/>').attr("name",c).val(b)).append(jQuery('<span  class="picktxt"></span>').text(g)).append(jQuery('<span  class="close pull-right">&times;</span>')))}}}function hsListFillPick(b,a,f){var c=b.closest(".pickbox");var e=c.hasClass("pickmul");var d=c.data("pickData")||{};if(!e){c.find(".checkall").hide()}if(!e){HsList.prototype._fill__radio.call(this,b,a,f)}else{HsList.prototype._fill__check.call(this,b,a,f)}if(d[a]!==undefined){b.find(".checkone").prop("checked",true).change()}}(function($){$(document).on("click","[data-toggle=hsPick],[data-toggle=hsFork]",function(){var url=$(this).attr("data-href")||$(this).attr("href");var box=$(this).attr("data-target");if(box){box=$(this)._hsTarget(box)}else{box=null}var inp=$(this).attr("data-fill-area");if(inp){inp=inp.charAt(0)==">"?$(inp,this):$(inp)}else{inp=$(this).siblings("[name],[data-fn]")}var fun=$(this).attr("data-fill-func");if(fun){fun=eval("("+fun+")")}$(this).hsPick(url,box,inp,fun);return false})})(jQuery);jQuery.fn.hsFork=jQuery.fn.hsPick;hsFormFillFork=hsFormFillPick;hsListFillFork=hsListFillPick;hsForkFillForm=hsFormFillPick;hsForkFillList=hsListFillPick;(function(a){a.fn.hsFileVali=function(b){};a.fn.hsFilePick=function(e,f){if(!f){return}e=a(e);var c=f.replace(/^.*[\/\\]/,"");var d=a(this).clone();var b=a(this).parent();var g=a('<li class="btn btn-success form-control"></li>').attr("title",c).append(this).append('<span class="glyphicon glyphicon-file"></span>').append(a('<span  class="picktxt"></span>').text(c)).append('<span class="close pull-right" >&times;</span>');e.append(g);b.append(d);d.val("");return g};a.fn.hsFillFile=function(d,e){if(!e){return}var c=a(this);var b=e.replace(/^.*[\/\\]/,"");var f=a('<li class="btn btn-success form-control"></li>').attr("title",b).append(a('<input class="pickval" type="hidden"/>').attr("name",d).val(e)).append('<span class="glyphicon glyphicon-file"></span>').append(a('<span  class="picktxt"></span>').text(b)).append('<span class="close pull-right" >&times;</span>');c.append(f);return f};a.fn.hsFileLoad=function(b){this.each(function(){var d=this;if(window.FileReader){var c=new FileReader();c.onloadend=function(f){b.call(d,f.target.result)};b.call(d);a.each(this.files,function(f,e){c.readAsDataURL(e)})}else{if(this.getAsDataURL){b.call(d,d.getAsDataURL())}else{b.call(d,d.value)}}});return this};a.fn.hsFileView=function(f,b,j,g,d){if(!b){return}f=a(f);var i=a(this).clone();var l=a(this).parent();var e=d?a.hsKeepView(b,j,g):a.hsPickView(b,j,g);e.css("positoin","absolute");var c=a('<li class="preview"></li>').css({width:j+"px",height:g+"px",overflow:"hidden",position:"relative"}).append(this).append(e).append('<a href="javascript:;" class="close pull-right">&times</a>');f.append(c);l.append(i);i.val("");return c};a.fn.hsFillView=function(g,i,b,e,d){if(!i){return}var f=a(this);var c=d?a.hsKeepView(i,b,e):a.hsPickView(i,b,e);c.css("positoin","absolute");var j=a('<li class="preview"></li>').css({width:b+"px",height:e+"px",overflow:"hidden",position:"relative"}).append(a('<input type="hidden" />').attr("name",g).val(i)).append(c).append('<a href="javascript:;" class="close pull-right">&times</a>');f.append(j);return j};a.hsPickView=function(e,b,d){var c=new Image();c.onload=function(){var h=c.width;var g=c.height;var f=g*b/d;if(f>h){c.width=b;c.height=g*b/h;a(c).css("top",(((d-c.height)/2))+"px")}else{c.height=d;c.width=h*d/g;a(c).css("left",(((b-c.width)/2))+"px")}};c.src=e;return a(c)};a.hsKeepView=function(e,b,d){var c=new Image();c.onload=function(){var h=c.width;var g=c.height;var f=g*b/d;if(f<h){c.width=b;c.height=g*b/h;a(c).css("top",(((d-c.height)/2))+"px")}else{c.height=d;c.width=h*d/g;a(c).css("left",(((b-c.width)/2))+"px")}};c.src=e;return a(c)};a(document).on("click",".forkbox .close,.pickbox .close,.preview .close",function(){a(this).parent().remove()})})(jQuery);